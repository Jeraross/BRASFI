{% extends "layout.html" %}
{% load static %}

{% block title %}
    Quizzes | BRASFI
{% endblock %}

{% block body %}

    {% if user.userType == "mentor" %}
        <button id="popup-btn" class="btn new-post-btn" onclick="createquiz()">Criar Quiz</button>
    {% endif %}
    
    {% if quizzes_with_ranking %}
    <div class="posts-view">
        {% for item in quizzes_with_ranking %}
        {% if user.userType == "aprendiz" or user == item.quiz.user %}
        <div class="post-card">
            <!-- Cabeçalho -->
            <div class="post-header">
                <div class="creator-info">
                    <div class="small-profilepic" style="background-image: url('/media/{{ item.quiz.user.profilePic }}');"></div>
                    <div>
                        <div class="username">{{ item.quiz.user.username }}</div>
                        <div class="user-type">{{ item.quiz.user.userType }}</div>
                    </div>
                </div>
                <div class="created-at">{{ item.quiz.created_at|date:"d M Y · H:i" }}</div>
            </div>

            <div class="post-details">
                <h3 class="video-title">{{ item.quiz.title }}</h3>
                <p class="video-description">{{ item.quiz.description }}</p>
            </div>

            {% if user.userType == "aprendiz" and item.user_result %}
            <div class="post-details">
                <p class="video-description">
                    Seu desempenho: <strong>{{ item.user_result.score }}/{{ item.user_result.total }}</strong> ({{ item.user_result.percentage|floatformat:1 }}%)
                </p>
                <div class="progress" style="height: 10px;">
                    <div class="progress-bar bg-success" role="progressbar"
                            style="width: {{ item.user_result.percentage|floatformat:0 }}%;" 
                            aria-valuenow="{{ item.user_result.percentage|floatformat:0 }}" 
                            aria-valuemin="0" aria-valuemax="100">
                    </div>
                </div>
            </div>
            {% endif %}

            {% if item.ranking and user.userType == "mentor" %}
            <div class="post-details">
                <strong class="text-secondary mb-2 d-block">Ranking dos Alunos:</strong>
                <ul class="list-group" style="border-radius: 10px; overflow: hidden;">
                    {% for result in item.ranking %}
                    <li class="list-group-item d-flex justify-content-between align-items-center" style="font-size: 0.95rem;">
                        {{ result.user.username }}
                        <span class="badge bg-success text-white rounded-pill" style="font-size: 0.85rem;">
                            {{ result.percentage|floatformat:1 }}% ({{ result.score }}/{{ result.total }})
                        </span>
                    </li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}

            {% if user.userType == "mentor" %}
                <a href="{% url 'App_BRASFI:edit_quiz' item.quiz.id %}" class="btn btn-warning">Editar</a>
                <button class="btn btn-danger" onclick="deleteQuiz('{{ item.quiz.id }}')">Excluir</button>
            {% elif user.userType == "aprendiz" %}
                <a href="{% url 'App_BRASFI:play_quiz' item.quiz.id %}" class="btn btn-primary">Executar</a>
            {% endif %}

        </div>
        {% endif %}
        {% endfor %}
    </div>

    {% else %}
    <div class="posts-view">
        <div>Nenhum quiz encontrado.</div>
    </div>
    {% endif %}

{% endblock %}
