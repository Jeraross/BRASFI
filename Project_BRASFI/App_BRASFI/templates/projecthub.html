{% extends "layout.html" %}
{% load static %}

{% block title %}
    Hub de Projetos | BRASFI
{% endblock %}

{% block body %}
    {# S√≥ mostra o bot√£o de criar para aprendizes #}
    {% if user.userType == "aprendiz" %}
        <button id="popup-btn" class="btn new-post-btn" onclick="createproject()">Criar Projeto</button>
    {% endif %}

    {% if projetos %}
    <div class="posts-view">
        {% for projeto in projetos %}
        <div class="post-card">
            <!-- Header: Criador e Data -->
            <div class="post-header">
                <div class="creator-info">
                    <div class="small-profilepic"
                         style="background-image: url('/media/{{ projeto.user.profilePic }}');"></div>
                    <div>
                        <div class="username">{{ projeto.user.username }}</div>
                        <div class="user-type">{{ projeto.user.userType }}</div>
                    </div>
                </div>
                <div class="created-at">{{ projeto.created_at|date:"d M Y ¬∑ H:i" }}</div>
            </div>

            <!-- Conte√∫do -->
            <div class="post-details">
                <h3>{{ projeto.title }}</h3>
                <p><strong>√Årea de Impacto:</strong> {{ projeto.get_impact_area_display }}</p>
                <p><strong>Descri√ß√£o:</strong> {{ projeto.description }}</p>
                <p><strong>Objetivos:</strong> {{ projeto.objective }}</p>
            </div>

            <!-- Toggle f√≥rum -->
            <button onclick="toggleForum({{ projeto.id }})">üí¨ Discuss√µes</button>
            <div id="forum-{{ projeto.id }}" style="display:none; margin-top:10px;">
                {% for comentario in projeto.comentarios.all %}
                    <div>
                        <strong>{{ comentario.autor.username }}</strong>: {{ comentario.mensagem }}<br>
                        <small>{{ comentario.criado_em|date:"d M Y H:i" }}</small>

                        {% for resposta in comentario.respostas.all %}
                            <div style="margin-left:20px;">
                                <strong>{{ resposta.autor.username }}</strong>: {{ resposta.mensagem }}<br>
                                <small>{{ resposta.criado_em|date:"d M Y H:i" }}</small>
                            </div>
                        {% endfor %}

                        {% if user.userType == "aprendiz" %}
                        <form method="post" action="{% url 'App_BRASFI:responder_comentario' comentario.id %}">
                            {% csrf_token %}
                            <textarea name="mensagem" rows="1" placeholder="Responder..." required></textarea>
                            <button type="submit">Responder</button>
                        </form>
                        {% endif %}
                    </div>
                    <hr>
                {% endfor %}

                {% if user.userType == "aprendiz" %}
                <form method="post" action="{% url 'App_BRASFI:novo_comentario' projeto.id %}">
                    {% csrf_token %}
                    <textarea name="mensagem" rows="2" placeholder="Novo coment√°rio..." required></textarea><br>
                    <button type="submit">Publicar</button>
                </form>
                {% else %}
                <p>Voc√™ precisa ser aprendiz para comentar.</p>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="posts-view">
        <p>Nenhum projeto aprovado encontrado.</p>
    </div>
    {% endif %}

    {# --- In√≠cio do script de toggle de f√≥rum --- #}
    <script>
        function toggleForum(id) {
            const forum = document.getElementById(`forum-${id}`);
            if (!forum) return;
            forum.style.display = forum.style.display === 'none' ? 'block' : 'none';
        }
    </script>
    {# --- Fim do script --- #}

{% endblock %}