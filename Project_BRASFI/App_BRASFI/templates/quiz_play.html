{% extends "layout.html" %}
{% load static %}

{% block title %}Executar Quiz{% endblock %}

{% block body %}
<div class="container mt-4">
    <h2>{{ quiz.title }}</h2>
    <div id="quiz-container">
        <p id="question-number" class="fs-5 fw-bold"></p>
        <p id="question-text" class="fs-4"></p>

        <div id="choices" class="mb-3"></div>

        <p id="timer" class="text-danger fs-5 fw-bold"></p>
        <p id="feedback" class="fw-bold"></p>

        <button id="next-button" class="btn btn-primary mt-3" style="display:none;" onclick="nextQuestion()">Próxima</button>
    </div>

    <div id="result" style="display:none;" class="mt-4">
        <h4>Quiz finalizado!</h4>
        <p>Você acertou <span id="correct-count"></span> de {{ questions|length }} perguntas.</p>
        <a href="{% url 'App_BRASFI:quizzes' %}" class="btn btn-success">Voltar aos quizzes</a>
    </div>
</div>

<!-- JSON seguro para perguntas -->
{{ questions|json_script:"questions-data" }}

<!-- JSON seguro para tempo -->
<script id="time-limit" type="application/json">
    {{ time_per_question|default:20 }}
</script>

<script>
    const parsedQuestions = JSON.parse(document.getElementById('questions-data').textContent);
    const timeLimit = JSON.parse(document.getElementById('time-limit').textContent);
    let current = 0;
    let correctCount = 0;
    let timer;

    function renderQuestion() {
        const q = parsedQuestions[current];
        document.getElementById("question-number").innerText = `Pergunta ${current + 1} de ${parsedQuestions.length}`;
        document.getElementById("question-text").innerText = q.text;
        document.getElementById("feedback").innerText = "";
        document.getElementById("next-button").style.display = "none";

        const choicesDiv = document.getElementById("choices");
        choicesDiv.innerHTML = "";

        q.choices.forEach((choice, index) => {
            const btn = document.createElement("button");
            btn.innerText = choice.text;
            btn.className = "btn btn-outline-secondary d-block mb-2";
            btn.onclick = () => handleAnswer(index, choice.is_correct, btn);
            choicesDiv.appendChild(btn);
        });

        startTimer();
    }

    function startTimer() {
        let timeLeft = timeLimit;
        document.getElementById("timer").innerText = `Tempo restante: ${timeLeft}s`;

        timer = setInterval(() => {
            timeLeft--;
            document.getElementById("timer").innerText = `Tempo restante: ${timeLeft}s`;

            if (timeLeft <= 0) {
                clearInterval(timer);
                showCorrectAnswer();
            }
        }, 1000);
    }

    function handleAnswer(index, isCorrect, btn) {
        clearInterval(timer);
        disableChoices();

        if (isCorrect) {
            correctCount++;
            document.getElementById("feedback").innerText = "✅ Resposta correta!";
            btn.classList.remove("btn-outline-secondary");
            btn.classList.add("btn-success");
        } else {
            document.getElementById("feedback").innerText = "❌ Resposta incorreta!";
            btn.classList.remove("btn-outline-secondary");
            btn.classList.add("btn-danger");
            showCorrectAnswer();
        }

        document.getElementById("next-button").style.display = "inline-block";
    }

    function showCorrectAnswer() {
        const q = parsedQuestions[current];
        const buttons = document.querySelectorAll("#choices button");
        buttons.forEach((btn, idx) => {
            btn.disabled = true;
            if (q.choices[idx].is_correct) {
                btn.classList.remove("btn-outline-secondary");
                btn.classList.add("btn-success");
            }
        });

        if (!document.getElementById("feedback").innerText.includes("✅") &&
            !document.getElementById("feedback").innerText.includes("❌")) {
            document.getElementById("feedback").innerText = "⏰ Tempo esgotado!";
        }

        document.getElementById("next-button").style.display = "inline-block";
    }

    function disableChoices() {
        document.querySelectorAll("#choices button").forEach(btn => btn.disabled = true);
    }

    function nextQuestion() {
        current++;
        if (current < parsedQuestions.length) {
            renderQuestion();
        } else {
            showResult();
        }
    }

    function showResult() {
        document.getElementById("quiz-container").style.display = "none";
        document.getElementById("result").style.display = "block";
        document.getElementById("correct-count").innerText = correctCount;
    }

    window.onload = () => {
        renderQuestion();
    };
</script>
{% endblock %}