{% extends "layout.html" %}

{% load static %}

{% block title %}
Hub de Network | BRASFI
{% endblock %}

{% block body %}
<button id="popup-btn" class="btn new-post-btn" onclick="createtopic()">Criar Topico</button>

{% if TopicConversas %}
<div class="posts-view">
    {% for topic in TopicConversas %}
    <div class="post-card">
        <!-- Header: Criador e Data -->
        <div class="post-header">
            <div class="creator-info">
                <div class="small-profilepic" style="background-image: url('/media/{{ topic.user.profilePic }}');">
                </div>
                <div>
                    <div class="username">{{ topic.user.username }}</div>
                    <div class="user-type">{{ topic.user.userType }}</div>
                </div>
            </div>
            <div class="created-at">{{ topic.created_at|date:"d M Y Â· H:i" }}</div>
        </div>

        <!-- ConteÃºdo -->
        <div class="post-details">
            <h3>{{ topic.titulo }}</h3>
            <p><strong>DescriÃ§Ã£o:</strong> {{ topic.descricao }}</p>
        </div>

        {% if user.is_authenticated %}
            <button onclick="toggleForum({{ topic.id }})">ðŸ’¬ DiscussÃµes</button>
            <div id="forum-{{ topic.id }}" style="display:none; margin-top:10px;">
                {% for comentario in topic.comentarios.all %}
                    <div>
                        <strong>{{ comentario.autor.username }}</strong>: {{ comentario.mensagem }}<br>
                        <small>{{ comentario.criado_em|date:"d M Y H:i" }}</small>

                        {% for resposta in comentario.respostas.all %}
                            <div style="margin-left:20px;">
                                <strong>{{ resposta.autor.username }}</strong>: {{ resposta.mensagem }}<br>
                                <small>{{ resposta.criado_em|date:"d M Y H:i" }}</small>
                            </div>
                        {% endfor %}

                        <form method="post" action="{% url 'App_BRASFI:responder_comentario_topico' comentario.id %}">
                            {% csrf_token %}
                            <textarea name="mensagem" rows="1" placeholder="Responder..." required></textarea>
                            <button type="submit">Responder</button>
                        </form>
                    </div>
                    <hr>
                {% endfor %}

                <form method="post" action="{% url 'App_BRASFI:novo_comentario_topico' topic.id %}">
                    {% csrf_token %}
                    <textarea name="mensagem" rows="2" placeholder="Novo comentÃ¡rio..." required></textarea><br>
                    <button type="submit">Publicar</button>
                </form>
            </div>
        {% else %}
            <p>VocÃª precisa estar logado para comentar.</p>
        {% endif %}
    </div>
    {% endfor %}
</div>
{% else %}
<p>NÃ£o hÃ¡ tÃ³picos disponÃ­veis.</p>
{% endif %}
<script>
    function toggleForum(id) {
        const forum = document.getElementById(`forum-${id}`);
        if (!forum) return;
        forum.style.display = forum.style.display === 'none' ? 'block' : 'none';
    }
</script>

{% endblock %}